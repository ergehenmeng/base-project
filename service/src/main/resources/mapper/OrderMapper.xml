<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eghm.mapper.OrderMapper">

    <select id="getItemList" resultType="com.eghm.vo.business.order.ProductSnapshotVO">
        select
        r.id as orderId,
        t.member_id,
        t.order_no,
        t.store_id,
        r.item_id as productId,
        t.title as productTitle,
        r.sku_title,
        t.cover_url as productCover,
        t.product_type
        from `order` t left join item_order r on t.order_no = r.order_no
        where t.deleted = false and t.order_no = #{orderNo} and t.state = 7
    </select>

    <select id="getRestaurantList" resultType="com.eghm.vo.business.order.ProductSnapshotVO">
        select
            r.id as orderId,
            t.member_id,
            t.store_id,
            t.order_no,
            r.voucher_id as productId,
            t.title as productTitle,
            t.cover_url as productCover,
            t.product_type
        from `order` t left join voucher_order r on t.order_no = r.order_no
        where t.deleted = false and t.order_no = #{orderNo} and t.state = 7
    </select>

    <select id="getTicketList" resultType="com.eghm.vo.business.order.ProductSnapshotVO">
        select
            r.id as orderId,
            t.member_id,
            t.store_id,
            t.order_no,
            r.ticket_id as productId,
            t.title as productTitle,
            t.cover_url as productCover,
            t.product_type
        from `order` t left join ticket_order r on t.order_no = r.order_no
        where t.deleted = false and t.order_no = #{orderNo} and t.state = 7
    </select>

    <select id="getLineList" resultType="com.eghm.vo.business.order.ProductSnapshotVO">
        select
            r.id as orderId,
            t.member_id,
            t.store_id,
            t.order_no,
            r.line_id as productId,
            t.title as productTitle,
            t.cover_url as productCover,
            t.product_type
        from `order` t left join line_order r on t.order_no = r.order_no
        where t.deleted = false and t.order_no = #{orderNo} and t.state = 7
    </select>

    <select id="getHomestayList" resultType="com.eghm.vo.business.order.ProductSnapshotVO">
        select
            r.id as orderId,
            t.member_id,
            t.store_id,
            t.order_no,
            r.line_id as productId,
            t.title as productTitle,
            t.cover_url as productCover,
            t.product_type
        from `order` t left join line_order r on t.order_no = r.order_no
        where t.deleted = false and t.order_no = #{orderNo} and t.state = 7
    </select>

    <select id="dayOrder" parameterType="com.eghm.dto.statistics.DateRequest" resultType="com.eghm.vo.business.statistics.OrderStatisticsVO">
        select
        count(id) as orderNum,
        sum(pay_amount) as payAmount,
        create_date
        from `order` where deleted = false and state in (1, 2, 3, 4, 5, 6, 7, 8)
        and create_time &gt;= #{startDate} and create_date &lt; #{endDate}
        <if test="merchantId != null">
            and merchant_id = #{merchantId}
        </if>
        group by create_date
    </select>

    <select id="orderStatistics" parameterType="com.eghm.dto.statistics.DateRequest" resultType="com.eghm.vo.business.statistics.OrderStatisticsVO">
        select
            count(id) as orderNum,
            sum(pay_amount) as payAmount
        from `order` where deleted = false and state in (1, 2, 3, 4, 5, 6, 7, 8)
        and create_time &gt;= #{startDate} and create_date &lt; #{endDate}
        <if test="merchantId != null">
            and merchant_id = #{merchantId}
        </if>
    </select>

    <update id="updateBookingState">
        update `order` set booking_state = #{bookingState} where order_no = #{orderNo} and booking_no = #{bookingNo}
    </update>

</mapper>
